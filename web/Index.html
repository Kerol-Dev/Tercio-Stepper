<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Tercio Labs – Multi-Motor CAN Control</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b0e;
      --fg: #e5e7eb;
      --card: #121217;
      --card2: #0f1117;
      --border: #262632;
      --muted: #9ca3af;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;
      --switch-bg: #1f2937;
      --switch-on: #10b981;
      --switch-knob: #fff;
      --field-bg: #1b1f2a;
      --field-border: #2e3347;
      --btn-secondary-bg: #1f2937;
      --btn-secondary-fg: #e5e7eb;

      --row-bg: #0e111a;
      --log-bg: #000;

      --badge-bg: rgba(255, 255, 255, 0.06);
      --badge-fg: #e5e7eb;
    }

    /* THEME – DARK */
    :root[data-theme="dark"] {
      --bg: #0b0b0e;
      --fg: #e5e7eb;
      --card: #121217;
      --card2: #0f1117;
      --border: #262632;
      --muted: #9ca3af;
      --accent: #10b981;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;

      --field-bg: #1b1f2a;
      --field-border: #2e3347;

      --btn-secondary-bg: #1f2937;
      --btn-secondary-fg: #e5e7eb;

      --row-bg: #0e111a;
      --log-bg: #000;

      --badge-bg: rgba(255, 255, 255, 0.06);
      --badge-fg: #e5e7eb;

      --switch-bg: #1f2937;
      --switch-on: #10b981;
      --switch-knob: #fff;
    }

    /* THEME – LIGHT (no dark boxes, proper contrast) */
    :root[data-theme="light"] {
      --bg: #f7f8fc;
      --fg: #0f172a;
      --card: #ffffff;
      --card2: #f5f7fb;
      --border: #d7deea;
      --muted: #64748b;
      --accent: #059669;
      --accent-2: #2563eb;
      --warn: #d97706;
      --danger: #dc2626;

      --field-bg: #f3f6fb;
      --field-border: #d7deea;

      --btn-secondary-bg: #eef2f7;
      --btn-secondary-fg: #0f172a;

      --row-bg: #ffffff;
      --log-bg: #111;

      --badge-bg: rgba(15, 23, 42, 0.06);
      --badge-fg: #0f172a;

      --switch-bg: #e5e7eb;
      --switch-on: #059669;
      --switch-knob: #fff;
    }

    @media (prefers-color-scheme: light) {
      :root[data-theme="auto"] {
        color-scheme: light
      }
    }

    @media (prefers-color-scheme: dark) {
      :root[data-theme="auto"] {
        color-scheme: dark
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      max-width: 100%;
      overflow-x: hidden
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 24px
    }

    h2 {
      margin: 0 0 8px 0
    }

    small {
      color: var(--muted)
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px
    }

    @media (max-width:1024px) {
      .app {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .theme-label {
      margin-left: 12px;
      color: var(--muted)
    }

    .btn {
      background: var(--accent);
      border: 0;
      color: #08221a;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600
    }

    .btn.secondary {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-fg)
    }

    .btn.info {
      background: var(--accent-2);
      color: #081422
    }

    .btn.warn {
      background: var(--warn);
      color: #1b1405
    }

    .btn.danger {
      background: var(--danger);
      color: #2b0b0b
    }

    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed
    }

    input,
    select,
    textarea {
      background: var(--field-bg);
      border: 1px solid var(--field-border);
      color: var(--fg);
      border-radius: 10px;
      padding: 12px 14px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Consolas, Monaco, monospace
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px
    }

    @media (max-width:1024px) {
      .split {
        grid-template-columns: 1fr
      }
    }

    .pill {
      background: var(--badge-bg);
      color: var(--badge-fg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      display: inline-flex;
      gap: 8px;
      align-items: center
    }

    .hint {
      color: var(--muted);
      font-size: 12px
    }

    .warnbar {
      background: #2a1111;
      border: 1px solid #6b1d1d;
      color: #ffd2d2;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
      align-items: center
    }

    .hidden {
      display: none
    }


    /* Devices header layout */
    .dev-header2 {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 12px;
    }

    .dev-header2 .title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dev-header2 .title h2 {
      margin: 0
    }

    .dev-header2 .title .sub {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.2;
    }

    /* Right-side controls sit on one line */
    .dev-header2 .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Compact theme label + select */
    .theme-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-row>span {
      color: var(--muted);
      font-weight: 600;
    }

    /* Make the select height match the button better */
    .dev-header2 .controls select {
      padding: 8px 12px;
      border-radius: 10px;
    }

    /* Mobile fallback: stack nicely */
    @media (max-width:700px) {
      .dev-header2 {
        flex-direction: column;
        align-items: stretch;
      }

      .dev-header2 .controls {
        flex-wrap: wrap;
      }
    }

    .search {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .dev-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 60vh;
      overflow: auto
    }

    .dev-item {
      border: 1px solid var(--border);
      background: var(--row-bg);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      cursor: pointer
    }

    .dev-item.active {
      outline: 2px solid var(--accent)
    }

    .dev-item:focus {
      outline: 2px solid var(--accent-2)
    }

    .dev-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    .tag {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--badge-bg);
      color: var(--badge-fg)
    }

    .tag.warn {
      border-color: #6b1d1d;
      background: #2a1111;
      color: #ffd2d2
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    #log {
      background: var(--log-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      height: 36vh;
      overflow: auto;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      cursor: pointer
    }

    .toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none
    }

    .switch {
      width: 46px;
      height: 26px;
      background: var(--switch-bg);
      border: 1px solid var(--field-border);
      border-radius: 999px;
      position: relative;
      transition: .2s
    }

    .knob {
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 2px;
      transform: translateY(-50%);
      transition: left .2s
    }

    .toggle input:checked+.switch {
      background: var(--switch-on);
      border-color: transparent
    }

    .toggle input:checked+.switch .knob {
      left: 22px
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px
    }

    td,
    th {
      font-size: 13px;
      text-align: left;
      padding: 8px 10px
    }

    tr {
      background: var(--row-bg);
      border: 1px solid var(--border)
    }

    tr td:first-child,
    tr th:first-child {
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px
    }

    tr td:last-child,
    tr th:last-child {
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px
    }

    /* Label spacing & inline "(rad)" fix */
    label:not(.toggle) {
      display: block !important;
      margin: 0 0 16px !important
    }

    label:not(.toggle)>input,
    label:not(.toggle)>select,
    label:not(.toggle)>textarea {
      display: block;
      width: 100%;
      margin-top: 12px !important
    }

    .label-inline {
      display: inline
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="card">
      <div class="dev-header2">
        <div class="title">
          <h2>Devices</h2>
          <span class="sub">Auto-discovered from telemetry</span>
        </div>
        <div class="controls">
          <button id="btnConnect" class="btn">Connect</button>
          <select id="selTheme" title="Theme">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>

      <div class="search"> <input id="devSearch" placeholder="Filter by ID/status…" class="mono" style="flex:1"> <button
          id="btnRefreshDevices" class="btn secondary">Refresh Devices</button> <button id="btnExport"
          class="btn secondary">Export CSV</button> </div>
      <div id="devList" class="dev-list" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="section-title">
        <div class="row">
          <h2 style="margin:0">Control</h2>
          <div id="status" class="pill"><small>Idle</small></div>
        </div>
        <div class="row">
          <div class="pill"><b>Active:</b> <span id="activeId" class="mono">—</span></div>
          <div class="pill"><b>Units:</b> <span id="activeUnits" class="mono">rad</span></div>
        </div>
      </div>

      <div id="calibWarn" class="warnbar hidden"><b>⚠ Not calibrated.</b> Run <i>Do Calibrate</i> on this device.</div>

      <div class="split" style="margin-top:10px">
        <div class="card">
          <div class="section-title">
            <h3 style="margin:0;font-size:16px">Quick Target</h3>
            <div class="pill"><b>Preview:</b> <span id="preview" class="mono">—</span></div>
          </div>
          <div class="grid">
            <label>
              <span class="label-inline">Target (<span id="targetUnits">rad</span>)</span>
              <input type="number" id="inTarget" step="0.001" value="0.50">
            </label>
            <label>Speed limit (rps)<input type="number" id="inRps" step="0.01" value="5.0"></label>
            <label>Accel limit (rps²)<input type="number" id="inRps2" step="0.1" value="25.0"></label>
            <label>Current (mA)<input type="number" id="inmA" step="1" value="1200"></label>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="btnSendTarget" class="btn info gated">Send Target</button>
            <button id="btnSendLimits" class="btn secondary gated">Send Limits</button>
            <button id="btnSetCurrent" class="btn secondary gated">Set Current</button>
            <button id="btnCal" class="btn warn gated">Do Calibrate</button>
            <label class="toggle gated"><input id="tglEnable" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Enable Motor</span></label>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="btn0" class="btn secondary gated">0</button>
            <button id="btn90" class="btn secondary gated">90°/π/2</button>
            <button id="btn180" class="btn secondary gated">180°/π</button>
          </div>
          <div class="hint" style="margin-top:6px">Frames: <span class="mono">ID_LO ID_H CMD LEN PAYLOAD…</span></div>
        </div>

        <div class="card">
          <div class="section-title">
            <h3 style="margin:0;font-size:16px">Device Setup</h3>
          </div>
          <div class="grid">
            <label>Change ID<input id="newId" type="number" min="0" max="2047" value="2"></label>
            <label>Microsteps<input id="ms" type="number" min="1" value="16"></label>
            <label>Steps/Rev<input id="spr" type="number" min="1" value="200"></label>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="btnApplyID" class="btn danger gated">Set ID</button>
            <button id="btnApplyStepper" class="btn secondary gated">Apply Stepper Params</button>
          </div>

          <div class="section-title" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">Modes & Flags</h3>
          </div>
          <div class="toolbar" style="flex-wrap:wrap">
            <label class="toggle gated"><input id="tglUnitsDeg" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Use Degrees</span></label>
            <label class="toggle gated"><input id="tglStealth" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>StealthChop</span></label>
            <label class="toggle gated"><input id="tglExtEnc" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>External Encoder</span></label>
            <label class="toggle gated"><input id="tglExtMode" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>External Mode</span></label>
            <label class="toggle gated"><input id="tglEndstop" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Endstop</span></label>
            <label class="toggle gated"><input id="tglEncInvert" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Encoder Invert</span></label>
            <label class="toggle gated"><input id="tglDirInvert" type="checkbox"><span class="switch"><span
                  class="knob"></span></span><span>Direction Invert</span></label>
          </div>

          <div class="section-title" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">PID</h3>
          </div>
          <div class="grid">
            <label>Kp<input id="pidKp" type="number" step="0.001" value="5.0"></label>
            <label>Ki<input id="pidKi" type="number" step="0.001" value="0.0"></label>
            <label>Kd<input id="pidKd" type="number" step="0.001" value="0.0"></label>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="btnApplyPID" class="btn secondary gated">Apply PID</button>
          </div>

          <div class="section-title" style="margin-top:12px">
            <h3 style="margin:0;font-size:16px">Homing</h3>
          </div>
          <div class="grid">
            <label>Offset<input id="homeOffset" type="number" step="0.001" value="0.0"></label>
            <label>Speed (rps)<input id="homeSpeed" type="number" step="0.01" value="1.0"></label>
          </div>
          <div class="toolbar" style="flex-wrap:wrap">
            <label class="toggle gated"><input id="homeUseMin" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Use MIN trigger</span></label>
            <label class="toggle gated"><input id="homeActiveLow" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Active Low</span></label>
            <label class="toggle gated"><input id="homeDirPlus" type="checkbox" checked><span class="switch"><span
                  class="knob"></span></span><span>Direction (+)</span></label>
            <button id="btnDoHome" class="btn warn gated">Do Homing</button>
          </div>

          <div class="section-title" style="margin-top:14px">
            <h3 style="margin:0;font-size:16px">Bulk ID Tools</h3>
          </div>
          <div class="row">
            <label>Start ID <input id="bulkStart" type="number" min="0" max="2047" value="1"
                style="width:110px"></label>
            <button id="btnSequential" class="btn warn">Assign Sequential IDs</button>
            <button id="btnRefreshList" class="btn secondary">Refresh List</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title">
          <h3 style="margin:0;font-size:16px">Live Telemetry</h3>
          <div class="row">
            <div class="pill"><b>Speed:</b> <span id="tlmSpeed" class="mono">—</span></div>
            <div class="pill"><b>Angle:</b> <span id="tlmAngle" class="mono">—</span></div>
            <div class="pill"><b>Temp:</b> <span id="tlmTemp" class="mono">—</span></div>
            <div class="pill"><b>Min:</b> <span id="tlmMin" class="mono">—</span></div>
            <div class="pill"><b>Max:</b> <span id="tlmMax" class="mono">—</span></div>
            <div class="pill"><b>Cal:</b> <span id="tlmCal" class="mono">—</span></div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Units</th>
              <th>Speed</th>
              <th>Angle</th>
              <th>Temp</th>
              <th>Min</th>
              <th>Max</th>
              <th>Cal</th>
              <th>Last seen</th>
            </tr>
          </thead>
          <tbody id="tblBodies"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="section-title">
          <h3 style="margin:0;font-size:16px">I/O Log</h3>
          <div class="toolbar">
            <button id="btnClear" class="btn secondary">Clear</button>
            <button id="btnSave" class="btn secondary">Save</button>
          </div>
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>
  <script>
    (() => {
      const $ = id => document.getElementById(id);
      const clamp11 = n => Math.max(0, Math.min(0x7FF, n | 0));
      const hex2 = b => b.toString(16).toUpperCase().padStart(2, '0');
      const bytesHex = u8 => Array.from(u8).map(hex2).join(' ');
      const u8 = v => new Uint8Array([v & 0xFF]);
      const u16le = v => new Uint8Array([v & 0xFF, (v >> 8) & 0xFF]);
      const f32le = f => { const b = new ArrayBuffer(4); new DataView(b).setFloat32(0, Number(f) || 0, true); return new Uint8Array(b); };

      // Commands (must match firmware)
      const CMD = {
        TARGET_ANGLE: 0x01, SET_CURRENT_MA: 0x02, SET_SPEED_LIMIT: 0x03, SET_PID: 0x04, SET_ID: 0x05,
        SET_MICROSTEPS: 0x06, SET_STEALTHCHOP: 0x07, SET_EXT_MODE: 0x08, SET_UNITS: 0x09, SET_ENC_INVERT: 0x0A,
        SET_ENABLED: 0x0B, SET_STEPS_PER_REV: 0x0C, DO_CALIBRATE: 0x0D, DO_HOMING: 0x0E, SET_ENDSTOP: 0x0F,
        SET_EXT_ENCODER: 0x10, SET_ACCEL_LIMIT: 0x11, SET_DIR_INVERT: 0x12,
        TELEMETRY: 0x01, GET_CONFIG: 0x20
      };
      const TELEMETRY_CAN_ID = 0x000;
      const header = (id, cmd, len) => new Uint8Array([id & 0xFF, (id >> 8) & 0xFF, cmd & 0xFF, len & 0xFF]);

      const frame = {
        target: (id, val) => { const p = f32le(val), h = header(id, CMD.TARGET_ANGLE, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        speed: (id, rps) => { const p = f32le(rps), h = header(id, CMD.SET_SPEED_LIMIT, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        accel: (id, a) => { const p = f32le(a), h = header(id, CMD.SET_ACCEL_LIMIT, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        current: (id, ma) => { const p = u16le(ma), h = header(id, CMD.SET_CURRENT_MA, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        setId: (id, nid) => { const p = u16le(clamp11(nid)), h = header(id, CMD.SET_ID, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        microsteps: (id, n) => { const p = u16le(n), h = header(id, CMD.SET_MICROSTEPS, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        stepsPerRev: (id, n) => { const p = u16le(n), h = header(id, CMD.SET_STEPS_PER_REV, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        bool1: (id, cmd, on) => { const p = u8(on ? 1 : 0), h = header(id, cmd, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        pid: (id, kp, ki, kd) => { const p = new Uint8Array(12); p.set(f32le(kp), 0); p.set(f32le(ki), 4); p.set(f32le(kd), 8); const h = header(id, CMD.SET_PID, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o; },
        calibrate: (id) => header(id, CMD.DO_CALIBRATE, 0),
        homing: (id, { useMINTrigger, offset, activeLow, speed, direction }) => {
          const p = new Uint8Array(11);
          p[0] = useMINTrigger ? 1 : 0; p.set(f32le(offset), 1); p[5] = activeLow ? 1 : 0; p.set(f32le(speed), 6); p[10] = direction ? 1 : 0;
          const h = header(id, CMD.DO_HOMING, p.length), o = new Uint8Array(h.length + p.length); o.set(h, 0); o.set(p, h.length); return o;
        },
        getConfig: (id) => header(id, CMD.GET_CONFIG, 0)
      };

      // THEME – global
      const selTheme = $('selTheme');
      const THEME_KEY = 'tercio_theme_global';
      const applyTheme = t => document.documentElement.setAttribute('data-theme', t || 'auto');
      const saveTheme = t => { try { localStorage.setItem(THEME_KEY, t) } catch { } };
      const loadTheme = () => { try { return localStorage.getItem(THEME_KEY) || 'auto' } catch { return 'auto' } };
      selTheme.value = loadTheme(); applyTheme(selTheme.value);
      selTheme.addEventListener('change', () => { const t = selTheme.value; applyTheme(t); saveTheme(t); });

      // UI refs
      const devListEl = $('devList'), devSearch = $('devSearch');
      const statusEl = $('status'), previewEl = $('preview');
      const activeIdEl = $('activeId'), activeUnitsEl = $('activeUnits'), targetUnitsEl = $('targetUnits');
      const inTarget = $('inTarget'), inRps = $('inRps'), inRps2 = $('inRps2'), inmA = $('inmA');
      const tglEnable = $('tglEnable');
      const newIdEl = $('newId'), msEl = $('ms'), sprEl = $('spr');
      const tglUnitsDeg = $('tglUnitsDeg'), tglStealth = $('tglStealth'), tglExtEnc = $('tglExtEnc'), tglExtMode = $('tglExtMode'), tglEndstop = $('tglEndstop'), tglEncInvert = $('tglEncInvert'), tglDirInvert = $('tglDirInvert');
      const pidKp = $('pidKp'), pidKi = $('pidKi'), pidKd = $('pidKd');
      const homeOffset = $('homeOffset'), homeSpeed = $('homeSpeed'), homeUseMin = $('homeUseMin'), homeActiveLow = $('homeActiveLow'), homeDirPlus = $('homeDirPlus');
      const tlmSpeed = $('tlmSpeed'), tlmAngle = $('tlmAngle'), tlmTemp = $('tlmTemp'), tlmMin = $('tlmMin'), tlmMax = $('tlmMax'), tlmCal = $('tlmCal');
      const tblBodies = $('tblBodies');
      const logEl = $('log');

      const setStatus = txt => statusEl.innerHTML = `<small>${txt}</small>`;
      const logLine = (p, buf, color) => { const time = new Date().toLocaleTimeString(); const text = (buf instanceof Uint8Array) ? bytesHex(buf) : String(buf); const div = document.createElement('div'); div.innerHTML = `<span style="color:#9ca3af">${time}</span> <b style="color:${color}">${p}</b> ${text}`; logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight; };
      const logTx = u8arr => logLine('>', u8arr, '#60a5fa'); const logInfo = t => logLine('*', t, '#f59e0b');

      // App state
      const store = { devices: new Map(), tiles: new Map(), activeId: null, requestedCfg: new Set(), lastCfgReqId: null };

      // Tiles
      function makeTile(id, st) {
        const root = document.createElement('div');
        root.className = 'dev-item'; root.tabIndex = 0; root.dataset.id = String(id); root.setAttribute('role', 'button'); root.setAttribute('aria-selected', 'false');
        root.innerHTML = `
        <div class="mono idtxt">0x${id.toString(16).toUpperCase()}</div>
        <div class="dev-tags">
          <span class="tag unit">units: ${st.units === 1 ? 'deg' : 'rad'}</span>
          <span class="tag spd">spd: ${st.speed != null ? st.speed.toFixed(2) : '—'}</span>
          <span class="tag ang">ang: ${st.angle != null ? st.angle.toFixed(2) : '—'}</span>
          <span class="tag tmp">T: ${st.temp != null ? st.temp.toFixed(1) : '—'}</span>
          <span class="tag cal ${st.cal ? '' : 'warn'}">${st.cal ? 'CAL' : 'UNCAL'}</span>
        </div>
        <div class="mono ts" style="opacity:.7">${st.ts ? new Date(st.ts).toLocaleTimeString() : ''}</div>`;
        const focus = () => setActive(id);
        root.onclick = focus; root.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); focus(); } };
        devListEl.appendChild(root);
        const fields = { root, unit: root.querySelector('.unit'), spd: root.querySelector('.spd'), ang: root.querySelector('.ang'), tmp: root.querySelector('.tmp'), cal: root.querySelector('.cal'), ts: root.querySelector('.ts'), idtxt: root.querySelector('.idtxt') };
        store.tiles.set(id, fields);
        return fields;
      }
      function updateTile(id, st) {
        let t = store.tiles.get(id); if (!t) t = makeTile(id, st);
        if (t.unit) t.unit.textContent = 'units: ' + (st.units === 1 ? 'deg' : 'rad');
        if (t.spd) t.spd.textContent = 'spd: ' + (st.speed != null ? st.speed.toFixed(2) : '—');
        if (t.ang) t.ang.textContent = 'ang: ' + (st.angle != null ? st.angle.toFixed(2) : '—');
        if (t.tmp) t.tmp.textContent = 'T: ' + (st.temp != null ? st.temp.toFixed(1) : '—');
        if (t.cal) { t.cal.textContent = st.cal ? 'CAL' : 'UNCAL'; t.cal.classList.toggle('warn', !st.cal); }
        if (t.ts) t.ts.textContent = st.ts ? new Date(st.ts).toLocaleTimeString() : '';
        const act = store.activeId === id; t.root.classList.toggle('active', act); t.root.setAttribute('aria-selected', act ? 'true' : 'false');
      }
      function filterList() {
        const q = (devSearch.value || '').trim().toLowerCase();
        for (const [id, t] of store.tiles) {
          const st = store.devices.get(id) || {};
          const txt = ('' + id) + ' ' + (st.cal ? 'calibrated' : 'not');
          t.root.style.display = (!q || txt.toLowerCase().includes(q)) ? '' : 'none';
        }
      }
      function refreshListDevices() {
        const ids = [...store.devices.keys()].sort((a, b) => a - b);
        ids.forEach(id => { const st = store.devices.get(id) || {}; if (!store.tiles.has(id)) makeTile(id, st); else updateTile(id, st); });
        filterList();
      }

      function setActive(id) {
        if (!store.devices.has(id)) return;
        store.activeId = id;
        for (const [tid, t] of store.tiles) { const act = tid === id; t.root.classList.toggle('active', act); t.root.setAttribute('aria-selected', act ? 'true' : 'false'); }
        sendBytes(frame.getConfig(id)); store.lastCfgReqId = id;
        renderActive(); gate(); preview();
      }
      function renderActive() {
        const st = store.devices.get(store.activeId);
        activeIdEl.textContent = (store.activeId == null) ? '—' : (`0x${store.activeId.toString(16).toUpperCase()} (${store.activeId})`);
        const units = st ? (st.units || 0) : 0;
        activeUnitsEl.textContent = units === 1 ? 'deg' : 'rad';
        targetUnitsEl.textContent = units === 1 ? 'deg' : 'rad';
        $('btn90').textContent = units === 1 ? '90°' : 'π/2';
        $('btn180').textContent = units === 1 ? '180°' : 'π';
        tlmSpeed.textContent = st && st.speed != null ? st.speed.toFixed(4) : '—';
        tlmAngle.textContent = st && st.angle != null ? st.angle.toFixed(4) : '—';
        tlmTemp.textContent = st && st.temp != null ? st.temp.toFixed(1) : '—';
        tlmMin.textContent = st && st.min != null ? (st.min ? 'YES' : 'NO') : '—';
        tlmMax.textContent = st && st.max != null ? (st.max ? 'YES' : 'NO') : '—';
        tlmCal.textContent = st && st.cal ? 'YES' : 'NO';
      }
      function renderTable() {
        const ids = [...store.devices.keys()].sort((a, b) => a - b);
        tblBodies.innerHTML = '';
        ids.forEach(id => {
          const s = store.devices.get(id) || {};
          const tr = document.createElement('tr');
          const td = v => { const el = document.createElement('td'); el.textContent = v; return el; };
          tr.appendChild(td(id));
          tr.appendChild(td(s.units === 1 ? 'deg' : 'rad'));
          tr.appendChild(td(s.speed != null ? s.speed.toFixed(3) : '—'));
          tr.appendChild(td(s.angle != null ? s.angle.toFixed(3) : '—'));
          tr.appendChild(td(s.temp != null ? s.temp.toFixed(1) : '—'));
          tr.appendChild(td(s.min != null ? (s.min ? 'YES' : 'NO') : '—'));
          tr.appendChild(td(s.max != null ? (s.max ? 'YES' : 'NO') : '—'));
          tr.appendChild(td(s.cal ? 'YES' : 'NO'));
          tr.appendChild(td(s.ts ? new Date(s.ts).toLocaleTimeString() : '—'));
          tblBodies.appendChild(tr);
        });
      }
      function gate() {
        const st = store.devices.get(store.activeId);
        const ok = !!(st && st.cal);
        document.querySelectorAll('.gated input, .gated select, .gated button, .gated textarea').forEach(el => { el.disabled = !ok; });
        $('calibWarn').classList.toggle('hidden', !(store.activeId && !ok));
      }
      function preview() {
        if (store.activeId == null) { previewEl.textContent = '—'; return; }
        const id = store.activeId, val = parseFloat(inTarget.value) || 0;
        previewEl.textContent = bytesHex(frame.target(id, val));
      }

      // Telemetry parsing (matches firmware packing)
      const AXIS_CFG_SIZE = 36;
      function parseTelemetryPayload(u8arr) {
        if (u8arr.length < AXIS_CFG_SIZE + 8) return null;
        const dv = new DataView(u8arr.buffer, u8arr.byteOffset, u8arr.byteLength);
        let o = 0; o += 4; o += 2; o += 2; const units = dv.getUint8(o); o += 1;
        const flags = dv.getUint8(o); o += 1;
        o += 2; o += 2; o += 4; o += 4; o += 4; o += 4; o += 4;
        const canArbId = dv.getUint16(o, true); o += 2;
        const speed = dv.getFloat32(o, true); o += 4;
        const angle = dv.getFloat32(o, true); o += 4;
        let temp = null, min = null, max = null; o += 4;
        if (u8arr.length >= AXIS_CFG_SIZE + 16) { temp = dv.getFloat32(o, true); o += 4; }
        if (u8arr.length >= AXIS_CFG_SIZE + 17) { min = dv.getUint8(o) !== 0; o += 1; }
        if (u8arr.length >= AXIS_CFG_SIZE + 18) { max = dv.getUint8(o) !== 0; }
        const cal = (flags & 0x40) !== 0;
        return { id: canArbId, units, speed, angle, temp, min, max, cal, flags };
      }
      function parseConfigPayload(u8arr) {
        if (u8arr.length < 2 + 2 + 2 + 1 + 1 + 12) return null;
        const dv = new DataView(u8arr.buffer, u8arr.byteOffset, u8arr.byteLength); let o = 0;
        const stepsPerRev = dv.getUint16(o, true); o += 2;
        const microsteps = dv.getUint16(o, true); o += 2;
        const currentmA = dv.getUint16(o, true); o += 2;
        const units = dv.getUint8(o); o += 1;
        const flags = dv.getUint8(o); o += 1;
        const kp = dv.getFloat32(o, true); o += 4;
        const ki = dv.getFloat32(o, true); o += 4;
        const kd = dv.getFloat32(o, true); o += 4;
        return { stepsPerRev, microsteps, currentmA, units, flags, kp, ki, kd };
      }

      // Flags (bit layout used by FW)
      const FL = { ENCINV: 0x01, DIRINV: 0x02, STEALTH: 0x04, EXTMODE: 0x08, ENDSTOP: 0x10, EXTENC: 0x20, CAL: 0x40 };
      function applyFlagsToFormFromByte(flags) {
        tglStealth.checked = !!(flags & FL.STEALTH);
        tglExtEnc.checked = !!(flags & FL.EXTENC);
        tglExtMode.checked = !!(flags & FL.EXTMODE);
        tglEndstop.checked = !!(flags & FL.ENDSTOP);
        tglEncInvert.checked = !!(flags & FL.ENCINV);
        tglDirInvert.checked = !!(flags & FL.DIRINV);
      }

      function syncFormFromState(id) {
        const st = store.devices.get(id); if (!st) return;

        // Units
        const isDeg = (st.units === 1);
        const u = $('tglUnitsDeg');
        if (u) { u.indeterminate = false; u.checked = isDeg; }

        // Flags bitfield
        const fl = st.flags ?? 0;
        const setCB = (el, on) => { if (!el) return; el.indeterminate = false; el.checked = !!on; };

        setCB($('tglStealth'), (fl & FL.STEALTH));
        setCB($('tglExtEnc'), (fl & FL.EXTENC));
        setCB($('tglExtMode'), (fl & FL.EXTMODE));
        setCB($('tglEndstop'), (fl & FL.ENDSTOP));
        setCB($('tglEncInvert'), (fl & FL.ENCINV));
        setCB($('tglDirInvert'), (fl & FL.DIRINV));

        // Scalars
        if (st.microsteps != null) $('ms').value = String(st.microsteps);
        if (st.stepsPerRev != null) $('spr').value = String(st.stepsPerRev);
        if (st.currentmA != null) $('inmA').value = String(st.currentmA);
        if (st.kp != null) $('pidKp').value = st.kp.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');
        if (st.ki != null) $('pidKi').value = st.ki.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');
        if (st.kd != null) $('pidKd').value = st.kd.toFixed(3).replace(/\.0+$/, '').replace(/\.$/, '');

        // Also update labels that depend on units
        $('activeUnits').textContent = isDeg ? 'deg' : 'rad';
        $('targetUnits').textContent = isDeg ? 'deg' : 'rad';
        $('btn90').textContent = isDeg ? '90°' : 'π/2';
        $('btn180').textContent = isDeg ? '180°' : 'π';
      }


      // Web Serial (single writer + queued writes)
      let port = null, reader = null, rxBuf = new Uint8Array(0);
      let writer = null, writeQueue = Promise.resolve();

      $('btnConnect').onclick = async () => {
        try {
          if (!('serial' in navigator)) { setStatus('Use Chrome/Edge.'); return; }
          if (port) {
            try { if (writer) { try { await writer.close?.() } catch { } try { writer.releaseLock() } catch { } writer = null; } reader?.releaseLock(); await port.close(); } catch { }
            port = null; setStatus('Disconnected'); $('btnConnect').textContent = 'Connect'; logInfo('Disconnected'); return;
          }
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 }); // fixed baud
          writer = port.writable.getWriter();
          setStatus('Connected'); $('btnConnect').textContent = 'Disconnect'; logInfo('Connected');
          devSearch.value = ''; filterList();
          reader = port.readable.getReader();
          (async () => { try { for (; ;) { const { value, done } = await reader.read(); if (done) break; if (value && value.length) appendBuf(value); } } catch { } })();
          navigator.serial.addEventListener('disconnect', e => { if (e.port === port) { $('btnConnect').click(); } });
        } catch (e) { setStatus('Connect failed: ' + (e?.message || e)); }
      };

      async function sendBytes(u8arr) {
        if (!port || !writer) return;
        writeQueue = writeQueue.then(async () => {
          try { await writer.write(u8arr); logTx(u8arr); }
          catch (e) { const msg = String(e?.message || e); if (msg.includes('WritableStream is locked')) return; setStatus('Write failed: ' + msg); }
        });
        return writeQueue;
      }

      function appendBuf(chunk) { const m = new Uint8Array(rxBuf.length + chunk.length); m.set(rxBuf, 0); m.set(chunk, rxBuf.length); rxBuf = m; processBuf(); }
      function processBuf() {
        while (rxBuf.length >= 4) {
          const id = rxBuf[0] | (rxBuf[1] << 8), cmd = rxBuf[2], len = rxBuf[3], total = 4 + len;
          if (rxBuf.length < total) return;
          const payload = rxBuf.subarray(4, 4 + len);

          if (id === TELEMETRY_CAN_ID && cmd === CMD.TELEMETRY) {
            const p = parseTelemetryPayload(payload);
            if (p) {
              const prev = store.devices.get(p.id) || {};
              const st = { ...prev, units: p.units, speed: p.speed, angle: p.angle, temp: p.temp, min: p.min, max: p.max, cal: p.cal, flags: p.flags, ts: Date.now() };
              store.devices.set(p.id, st);
              updateTile(p.id, st);
              // If active and we don't have config yet, mirror telemetry flags to form now
              if (store.activeId === p.id) {
                syncFormFromState(p.id);
                renderActive();  // updates Units display & quick buttons text
              }
              if (store.activeId === null) setActive(p.id);
              renderActive(); renderTable(); gate();
              if (!store.requestedCfg.has(p.id)) { store.requestedCfg.add(p.id); sendBytes(frame.getConfig(p.id)); store.lastCfgReqId = p.id; }
            }
          } else if (id === TELEMETRY_CAN_ID && cmd === CMD.GET_CONFIG) {
            const cfg = parseConfigPayload(payload);
            if (cfg) {
              const devId = store.lastCfgReqId ?? store.activeId;
              if (devId != null) {
                const prev = store.devices.get(devId) || {};
                const st = { ...prev, stepsPerRev: cfg.stepsPerRev, microsteps: cfg.microsteps, currentmA: cfg.currentmA, units: cfg.units, flags: cfg.flags, kp: cfg.kp, ki: cfg.ki, kd: cfg.kd };
                store.devices.set(devId, st);
                updateTile(devId, st);
                if (devId === store.activeId) { syncFormFromState(devId); }
                logInfo(`Config applied to ID ${devId}`);
                renderActive(); gate();
              }
            }
          }
          rxBuf = rxBuf.subarray(total);
        }
      }

      // Buttons / inputs
      $('btnRefreshDevices').onclick = () => { refreshListDevices(); };
      $('btnRefreshList').onclick = () => { refreshListDevices(); };
      devSearch.addEventListener('input', filterList);

      inTarget.addEventListener('input', preview);
      $('btn0').onclick = () => { inTarget.value = '0'; preview(); };
      $('btn90').onclick = () => { const st = store.devices.get(store.activeId); const isDeg = st && st.units === 1; inTarget.value = isDeg ? '90' : (Math.PI / 2).toFixed(3); preview(); };
      $('btn180').onclick = () => { const st = store.devices.get(store.activeId); const isDeg = st && st.units === 1; inTarget.value = isDeg ? '180' : (Math.PI).toFixed(3); preview(); };

      $('btnSendTarget').onclick = () => { if (store.activeId == null) return; sendBytes(frame.target(store.activeId, parseFloat(inTarget.value) || 0)); };
      $('btnSendLimits').onclick = () => { if (store.activeId == null) return; const id = store.activeId; const rps = parseFloat(inRps.value) || 0; const rps2 = parseFloat(inRps2.value) || 0; sendBytes(frame.speed(id, rps)); sendBytes(frame.accel(id, rps2)); };
      $('btnSetCurrent').onclick = () => { if (store.activeId == null) return; sendBytes(frame.current(store.activeId, parseInt(inmA.value, 10) || 0)); };
      $('btnCal').onclick = () => { if (store.activeId == null) return; sendBytes(frame.calibrate(store.activeId)); };
      tglEnable.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_ENABLED, tglEnable.checked)); };

      $('btnApplyID').onclick = () => {
        if (store.activeId == null) return; const oldId = store.activeId; const nid = clamp11(parseInt(newIdEl.value, 10) || 0); if (nid === oldId) return;
        sendBytes(frame.setId(oldId, nid));
        const st = store.devices.get(oldId) || {}; store.devices.delete(oldId); store.devices.set(nid, st);
        const tile = store.tiles.get(oldId); if (tile) { tile.root.dataset.id = String(nid); tile.idtxt.textContent = '0x' + nid.toString(16).toUpperCase(); store.tiles.delete(oldId); store.tiles.set(nid, tile); }
        setActive(nid);
      };
      $('btnApplyStepper').onclick = () => { if (store.activeId == null) return; const id = store.activeId; sendBytes(frame.microsteps(id, parseInt(msEl.value, 10) || 16)); sendBytes(frame.stepsPerRev(id, parseInt(sprEl.value, 10) || 200)); };

      tglUnitsDeg.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_UNITS, tglUnitsDeg.checked)); renderActive(); };
      tglStealth.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_STEALTHCHOP, tglStealth.checked)); };
      tglExtEnc.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_EXT_ENCODER, tglExtEnc.checked)); };
      tglExtMode.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_EXT_MODE, tglExtMode.checked)); };
      tglEndstop.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_ENDSTOP, tglEndstop.checked)); };
      tglEncInvert.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_ENC_INVERT, tglEncInvert.checked)); };
      tglDirInvert.onchange = () => { if (store.activeId == null) return; sendBytes(frame.bool1(store.activeId, CMD.SET_DIR_INVERT, tglDirInvert.checked)); };

      $('btnApplyPID').onclick = () => { if (store.activeId == null) return; const id = store.activeId; sendBytes(frame.pid(id, parseFloat(pidKp.value) || 0, parseFloat(pidKi.value) || 0, parseFloat(pidKd.value) || 0)); };

      $('btnDoHome').onclick = () => {
        if (store.activeId == null) return; const id = store.activeId;
        const params = { useMINTrigger: homeUseMin.checked, offset: parseFloat(homeOffset.value) || 0, activeLow: homeActiveLow.checked, speed: parseFloat(homeSpeed.value) || 0, direction: homeDirPlus.checked };
        sendBytes(frame.homing(id, params));
      };

      $('btnSequential').onclick = async () => {
        const ids = [...store.devices.keys()].sort((a, b) => a - b); const start = clamp11(parseInt($('bulkStart').value, 10) || 1);
        for (let i = 0; i < ids.length; i++) {
          const cur = ids[i], target = clamp11(start + i); if (cur === target) continue;
          await sendBytes(frame.setId(cur, target));
          const st = store.devices.get(cur) || {}; store.devices.delete(cur); store.devices.set(target, st);
          const tile = store.tiles.get(cur); if (tile) { tile.root.dataset.id = String(target); tile.idtxt.textContent = '0x' + target.toString(16).toUpperCase(); store.tiles.delete(cur); store.tiles.set(target, tile); }
        }
        refreshListDevices(); setStatus('Sequential IDs applied');
      };

      $('btnClear').onclick = () => { logEl.textContent = ''; };
      $('btnSave').onclick = () => { const lines = Array.from(logEl.children).map(el => el.textContent || ''); const blob = new Blob([lines.join('\n')], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'can_log.txt'; a.click(); URL.revokeObjectURL(url); };
      $('btnExport').onclick = () => {
        const rows = [['id', 'units', 'speed', 'angle', 'temp', 'min', 'max', 'cal', 'last_seen']];[...store.devices.keys()].sort((a, b) => a - b).forEach(id => { const s = store.devices.get(id) || {}; rows.push([id, s.units === 1 ? 'deg' : 'rad', s.speed ?? '', s.angle ?? '', s.temp ?? '', s.min ?? '', s.max ?? '', s.cal ? '1' : '0', s.ts ? new Date(s.ts).toISOString() : '']); });
        const csv = rows.map(r => r.map(x => String(x)).join(',')).join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'devices.csv'; a.click(); URL.revokeObjectURL(url);
      };

      // Initial paint
      renderTable(); gate();
    })();
  </script>
</body>

</html>